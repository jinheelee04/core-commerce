openapi: 3.0.3
info:
  title: E-commerce Core Service API
  description: |
    E-commerce Core Service의 RESTful API 명세서입니다.

    ## 주요 기능
    - 상품 조회 및 검색
    - 장바구니 관리
    - 주문 생성 및 조회
    - 결제 처리 (Mock PG)
    - 쿠폰 발급 및 사용

    ## 인증
    현재 버전에서는 `X-User-Id` 헤더를 통해 사용자를 식별합니다.
    실제 운영 환경에서는 JWT 등의 인증 방식으로 대체되어야 합니다.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:8080/api/v1
    description: 로컬 개발 서버

tags:
  - name: 상품
    description: 상품 조회 및 검색 API
  - name: 장바구니
    description: 장바구니 관리 API
  - name: 주문
    description: 주문 생성 및 조회 API
  - name: 결제
    description: 결제 처리 API
  - name: 쿠폰
    description: 쿠폰 발급 및 관리 API

paths:
  /products:
    get:
      tags:
        - 상품
      summary: 상품 목록 조회
      description: 카테고리, 가격 범위, 키워드 등으로 상품을 검색하고 페이징된 목록을 반환합니다.
      operationId: getProducts
      parameters:
        - name: category
          in: query
          description: 카테고리 필터
          schema:
            type: string
            example: ELECTRONICS or PERIPHERAL
        - name: keyword
          in: query
          description: 검색 키워드 (상품명, 설명)
          schema:
            type: string
            example: MacBook
        - name: minPrice
          in: query
          description: 최소 가격
          schema:
            type: integer
            format: int64
            example: 1000000
        - name: maxPrice
          in: query
          description: 최대 가격
          schema:
            type: integer
            format: int64
            example: 3000000
        - name: sort
          in: query
          description: 정렬 기준
          schema:
            type: string
            enum: ["price,asc", "price,desc", "createdAt,desc", "popular"]
            default: createdAt,desc
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/SizeParam'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Product'
              example:
                data:
                  - productId: 1
                    name: MacBook Pro
                    description: Apple M3 chip, 16GB RAM
                    price: 2500000
                    category: ELECTRONICS
                    brand: Apple
                    imageUrl: https://cdn.example.com/products/1.jpg
                    status: AVAILABLE
                    availableStock: 10
                    createdAt: '2025-01-15T10:00:00Z'
                meta:
                  page: 0
                  size: 20
                  totalElements: 100
                  totalPages: 5

  /products/{productId}:
    get:
      tags:
        - 상품
      summary: 상품 상세 조회
      description: 특정 상품의 상세 정보를 조회합니다.
      operationId: getProduct
      parameters:
        - name: productId
          in: path
          required: true
          description: 상품 ID
          schema:
            type: integer
            format: int64
            example: 1
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/ProductDetail'
        '404':
          $ref: '#/components/responses/ProductNotFound'

  /carts/me:
    get:
      tags:
        - 장바구니
      summary: 장바구니 조회
      description: 현재 사용자의 장바구니를 조회합니다.
      operationId: getCart
      security:
        - UserIdHeader: []
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Cart'

  /carts/items:
    post:
      tags:
        - 장바구니
      summary: 장바구니에 상품 담기
      description: 장바구니에 상품을 추가합니다. 이미 존재하는 상품이면 수량을 증가시킵니다.
      operationId: addCartItem
      security:
        - UserIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddCartItemRequest'
            example:
              productId: 1
              quantity: 2
      responses:
        '201':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/CartItem'
        '404':
          $ref: '#/components/responses/ProductNotFound'
        '400':
          description: 품절 상품
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: PRODUCT_OUT_OF_STOCK
                message: 품절된 상품입니다

    delete:
      tags:
        - 장바구니
      summary: 장바구니 전체 비우기
      description: 장바구니의 모든 상품을 삭제합니다.
      operationId: clearCart
      security:
        - UserIdHeader: []
      responses:
        '204':
          description: 성공

  /carts/items/{cartItemId}:
    patch:
      tags:
        - 장바구니
      summary: 장바구니 항목 수량 변경
      description: 장바구니 항목의 수량을 변경합니다.
      operationId: updateCartItem
      security:
        - UserIdHeader: []
      parameters:
        - name: cartItemId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCartItemRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/CartItem'
        '404':
          description: 장바구니 항목 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: CART_ITEM_NOT_FOUND
                message: 장바구니 항목을 찾을 수 없습니다

    delete:
      tags:
        - 장바구니
      summary: 장바구니 항목 삭제
      description: 장바구니에서 특정 항목을 삭제합니다.
      operationId: deleteCartItem
      security:
        - UserIdHeader: []
      parameters:
        - name: cartItemId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: 성공
        '404':
          description: 장바구니 항목 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: CART_ITEM_NOT_FOUND
                message: 장바구니 항목을 찾을 수 없습니다

  /orders:
    post:
      tags:
        - 주문
      summary: 주문 생성
      description: |
        장바구니의 상품들을 주문으로 생성합니다.

        **처리 과정:**
        1. 장바구니 항목 검증
        2. 쿠폰 검증 및 할인 계산 (선택)
        3. 재고 확인
        4. 주문 생성 (status=PENDING)
        5. 재고 예약 (reserved_stock += quantity)
      operationId: createOrder
      security:
        - UserIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
            example:
              cartItemIds: [1, 2]
              couponId: 10
              deliveryAddress: 서울시 강남구 테헤란로 123
              deliveryMemo: 문 앞에 놓아주세요
      responses:
        '201':
          description: 주문 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: 재고 부족
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: INSUFFICIENT_STOCK
                message: 재고가 부족합니다

    get:
      tags:
        - 주문
      summary: 주문 목록 조회
      description: 현재 사용자의 주문 목록을 조회합니다.
      operationId: getOrders
      security:
        - UserIdHeader: []
      parameters:
        - name: status
          in: query
          description: 주문 상태 필터
          schema:
            type: string
            enum: [PENDING, PAID, CONFIRMED, CANCELLED]
        - name: startsAt
          in: query
          description: 시작 날짜 (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: endsAt
          in: query
          description: 종료 날짜 (ISO 8601)
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/SizeParam'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/OrderSummary'

  /orders/{orderId}:
    get:
      tags:
        - 주문
      summary: 주문 상세 조회
      description: 특정 주문의 상세 정보를 조회합니다.
      operationId: getOrder
      security:
        - UserIdHeader: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/OrderDetail'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - 주문
      summary: 주문 취소
      description: |
        PENDING 상태의 주문을 취소합니다.

        **처리 과정:**
        1. 주문 상태를 CANCELLED로 변경
        2. 재고 예약 해제 (reserved_stock -= quantity)
        3. 쿠폰은 미사용 상태 유지
      operationId: cancelOrder
      security:
        - UserIdHeader: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [cancel]
                reason:
                  type: string
                  description: 취소 사유
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'

  /payments:
    post:
      tags:
        - 결제
      summary: 결제 요청
      description: |
        주문에 대한 결제를 처리합니다. Mock PG를 통해 80% 확률로 성공합니다.

        **결제 성공 시:**
        1. payments 생성 (status=SUCCESS)
        2. orders 상태 변경 (status=PAID)
        3. 재고 확정 차감 (stock -= qty, reserved_stock -= qty)
        4. 쿠폰 사용 처리 (is_used=true)

        **결제 실패 시:**
        1. payments 생성 (status=FAILED)
        2. orders 취소 (status=CANCELLED)
        3. 재고 예약 해제 (reserved_stock -= qty)
        4. 쿠폰 미사용 유지
      operationId: processPayment
      security:
        - UserIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequest'
            example:
              orderId: 456
              paymentMethod: CARD
              amount: 4980000
      responses:
        '200':
          description: 결제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Payment'
        '400':
          description: 결제 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                payment_failed:
                  summary: 결제 실패
                  value:
                    code: PAYMENT_FAILED
                    message: 결제에 실패했습니다
                    details:
                      failReason: 카드 한도 초과
                      pgResponse:
                        code: CARD_LIMIT_EXCEEDED
                amount_mismatch:
                  summary: 결제 금액 불일치
                  value:
                    code: PAYMENT_AMOUNT_MISMATCH
                    message: 결제 금액이 주문 금액과 일치하지 않습니다
                    details:
                      expectedAmount: 4980000
                      requestedAmount: 5000000

  /payments/{paymentId}:
    get:
      tags:
        - 결제
      summary: 결제 상세 조회
      description: 특정 결제의 상세 정보를 조회합니다.
      operationId: getPayment
      security:
        - UserIdHeader: []
      parameters:
        - name: paymentId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Payment'
        '404':
          $ref: '#/components/responses/NotFound'

  /orders/{orderId}/payment:
    get:
      tags:
        - 결제
      summary: 주문의 결제 정보 조회
      description: 특정 주문의 결제 정보를 조회합니다.
      operationId: getOrderPayment
      security:
        - UserIdHeader: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Payment'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/me/coupons:
    post:
      tags:
        - 쿠폰
      summary: 쿠폰 발급
      description: |
        쿠폰 코드로 쿠폰을 발급받습니다.

        **검증 사항:**
        - 쿠폰 상태 ACTIVE
        - 쿠폰 기간 내 (starts_at ~ ends_at)
        - 잔여 수량 존재
        - 중복 발급 불가 (1인 1매)
      operationId: issueCoupon
      security:
        - UserIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - couponCode
              properties:
                couponCode:
                  type: string
                  description: 쿠폰 코드
                  example: WELCOME2024
      responses:
        '201':
          description: 쿠폰 발급 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UserCoupon'
        '400':
          description: 쿠폰 발급 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                already_issued:
                  summary: 이미 발급된 쿠폰
                  value:
                    code: COUPON_ALREADY_ISSUED
                    message: 이미 발급받은 쿠폰입니다
                out_of_stock:
                  summary: 쿠폰 소진
                  value:
                    code: COUPON_OUT_OF_STOCK
                    message: 쿠폰이 모두 소진되었습니다

    get:
      tags:
        - 쿠폰
      summary: 내 쿠폰 목록 조회
      description: 현재 사용자가 보유한 쿠폰 목록을 조회합니다.
      operationId: getMyCoupons
      security:
        - UserIdHeader: []
      parameters:
        - name: isUsed
          in: query
          description: 사용 여부 필터
          schema:
            type: boolean
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserCoupon'

  /coupons/available:
    get:
      tags:
        - 쿠폰
      summary: 발급 가능한 쿠폰 목록 조회
      description: 현재 발급 가능한 쿠폰 목록을 조회합니다.
      operationId: getAvailableCoupons
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Coupon'

components:
  securitySchemes:
    UserIdHeader:
      type: apiKey
      in: header
      name: X-User-Id
      description: |
        사용자 ID를 헤더로 전달합니다.

        **예시:** `X-User-Id: 123`

        실제 운영 환경에서는 JWT Bearer Token 등으로 대체되어야 합니다.

  parameters:
    PageParam:
      name: page
      in: query
      description: 페이지 번호 (0-based)
      schema:
        type: integer
        default: 0
        minimum: 0
    SizeParam:
      name: size
      in: query
      description: 페이지 크기 (최대 100)
      schema:
        type: integer
        default: 20
        minimum: 1
        maximum: 100

  schemas:
    Product:
      type: object
      properties:
        productId:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: MacBook Pro
        description:
          type: string
          example: Apple M3 chip, 16GB RAM
        price:
          type: integer
          format: int64
          description: 가격 (원)
          example: 2500000
        category:
          type: string
          example: ELECTRONICS
        brand:
          type: string
          example: Apple
        imageUrl:
          type: string
          format: uri
          example: https://cdn.example.com/products/1.jpg
        status:
          type: string
          enum: [AVAILABLE, OUT_OF_STOCK]
          example: AVAILABLE
        availableStock:
          type: integer
          description: 사용 가능한 재고 (stock - reserved_stock)
          example: 10
        createdAt:
          type: string
          format: date-time
          example: '2025-01-15T10:00:00Z'

    ProductDetail:
      allOf:
        - $ref: '#/components/schemas/Product'
        - type: object
          properties:
            stock:
              type: integer
              description: 실제 재고
              example: 10
            reservedStock:
              type: integer
              description: 예약된 재고
              example: 2
            updatedAt:
              type: string
              format: date-time
              example: '2025-01-20T14:00:00Z'

    Cart:
      type: object
      properties:
        cartId:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        totalQuantity:
          type: integer
          example: 2
        totalAmount:
          type: integer
          format: int64
          description: 총 금액 (원)
          example: 5000000
        updatedAt:
          type: string
          format: date-time

    CartItem:
      type: object
      properties:
        cartItemId:
          type: integer
          format: int64
        productId:
          type: integer
          format: int64
        productName:
          type: string
        productImageUrl:
          type: string
          format: uri
        price:
          type: integer
          format: int64
          description: 단가 (원)
        quantity:
          type: integer
          minimum: 1
        subtotal:
          type: integer
          format: int64
          description: 소계 (원)
        availableStock:
          type: integer
          description: 사용 가능한 재고
        createdAt:
          type: string
          format: date-time

    AddCartItemRequest:
      type: object
      required:
        - productId
        - quantity
      properties:
        productId:
          type: integer
          format: int64
          example: 1
        quantity:
          type: integer
          minimum: 1
          example: 2

    UpdateCartItemRequest:
      type: object
      required:
        - quantity
      properties:
        quantity:
          type: integer
          minimum: 1
          example: 3

    CreateOrderRequest:
      type: object
      required:
        - cartItemIds
        - deliveryAddress
      properties:
        cartItemIds:
          type: array
          items:
            type: integer
            format: int64
          example: [1, 2]
        couponId:
          type: integer
          format: int64
          description: 사용할 쿠폰 ID (선택)
          example: 10
        deliveryAddress:
          type: string
          example: 서울시 강남구 테헤란로 123
        deliveryMemo:
          type: string
          example: 문 앞에 놓아주세요

    Order:
      type: object
      properties:
        orderId:
          type: integer
          format: int64
        orderNumber:
          type: string
          example: ORD-20250128-001
        status:
          type: string
          enum: [PENDING, PAID, CONFIRMED, CANCELLED]
          example: PENDING
        pricing:
          $ref: '#/components/schemas/OrderPricing'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        coupon:
          $ref: '#/components/schemas/OrderCoupon'
        deliveryAddress:
          type: string
        deliveryMemo:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderSummary:
      type: object
      properties:
        orderId:
          type: integer
          format: int64
        orderNumber:
          type: string
        status:
          type: string
          enum: [PENDING, PAID, CONFIRMED, CANCELLED]
        finalAmount:
          type: integer
          format: int64
        createdAt:
          type: string
          format: date-time

    OrderDetail:
      allOf:
        - $ref: '#/components/schemas/Order'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'
            paidAt:
              type: string
              format: date-time
            cancelledAt:
              type: string
              format: date-time
            cancelReason:
              type: string

    OrderPricing:
      type: object
      properties:
        itemsTotal:
          type: integer
          format: int64
          description: 상품 합계 금액
        discountAmount:
          type: integer
          format: int64
          description: 할인 금액
        finalAmount:
          type: integer
          format: int64
          description: 최종 결제 금액

    OrderItem:
      type: object
      properties:
        orderItemId:
          type: integer
          format: int64
        productId:
          type: integer
          format: int64
        productName:
          type: string
        quantity:
          type: integer
        unitPrice:
          type: integer
          format: int64
          description: 주문 시점 단가
        subtotal:
          type: integer
          format: int64

    OrderCoupon:
      type: object
      properties:
        userCouponId:
          type: integer
          format: int64
        name:
          type: string
        discountAmount:
          type: integer
          format: int64

    PaymentRequest:
      type: object
      required:
        - orderId
        - paymentMethod
        - amount
      properties:
        orderId:
          type: integer
          format: int64
          example: 456
        paymentMethod:
          type: string
          enum: [CARD, VIRTUAL_ACCOUNT, PHONE]
          example: CARD
        amount:
          type: integer
          format: int64
          description: 결제 금액 (원)
          example: 4980000

    Payment:
      type: object
      properties:
        paymentId:
          type: integer
          format: int64
        orderId:
          type: integer
          format: int64
        amount:
          type: integer
          format: int64
        paymentMethod:
          type: string
          enum: [CARD, VIRTUAL_ACCOUNT, PHONE]
        status:
          type: string
          enum: [PENDING, SUCCESS, FAILED]
        transactionId:
          type: string
          description: PG 거래 ID
        failReason:
          type: string
          description: 실패 사유
        paidAt:
          type: string
          format: date-time
        failedAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time

    Coupon:
      type: object
      properties:
        couponId:
          type: integer
          format: int64
        code:
          type: string
          example: WELCOME2024
        name:
          type: string
          example: 신규 회원 10% 할인
        description:
          type: string
        discountType:
          type: string
          enum: [PERCENTAGE, FIXED_AMOUNT]
        discountValue:
          type: integer
          description: 할인율(%) 또는 할인 금액(원)
        minOrderAmount:
          type: integer
          format: int64
          description: 최소 주문 금액
        maxDiscountAmount:
          type: integer
          format: int64
          description: 최대 할인 금액
        totalQuantity:
          type: integer
        remainingQuantity:
          type: integer
        startsAt:
          type: string
          format: date-time
        endsAt:
          type: string
          format: date-time
        status:
          type: string
          enum: [ACTIVE, INACTIVE, EXPIRED]

    UserCoupon:
      type: object
      properties:
        userCouponId:
          type: integer
          format: int64
        couponId:
          type: integer
          format: int64
        code:
          type: string
        name:
          type: string
        discountType:
          type: string
          enum: [PERCENTAGE, FIXED_AMOUNT]
        discountValue:
          type: integer
        minOrderAmount:
          type: integer
          format: int64
        maxDiscountAmount:
          type: integer
          format: int64
        isUsed:
          type: boolean
        issuedAt:
          type: string
          format: date-time
        usedAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time

    PagedResponse:
      type: object
      properties:
        meta:
          type: object
          properties:
            page:
              type: integer
              example: 0
            size:
              type: integer
              example: 20
            totalElements:
              type: integer
              example: 100
            totalPages:
              type: integer
              example: 5

    Error:
      type: object
      properties:
        code:
          type: string
          description: 에러 코드
        message:
          type: string
          description: 에러 메시지
        details:
          type: object
          description: 추가 세부 정보
          additionalProperties: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: BAD_REQUEST
            message: 잘못된 요청입니다

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: NOT_FOUND
            message: 리소스를 찾을 수 없습니다
    ProductNotFound:
      description: 상품을 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: PRODUCT_NOT_FOUND
            message: 상품을 찾을 수 없습니다

security:
  - UserIdHeader: []
